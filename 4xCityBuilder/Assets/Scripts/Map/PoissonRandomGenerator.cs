using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public static class PoissonRandomGenerator{

    public static int GetPoisson(float lambda)
    {
        return (lambda < 30.0) ? PoissonSmall(lambda) : PoissonLarge(lambda);
    }

    private static int PoissonSmall(float lambda)
    {
        // Algorithm due to Donald Knuth, 1969.
        float p = 1.0F, L = Mathf.Exp(-lambda);
        int k = 0;
        do
        {
            k++;
            p *= Random.Range(0F,1F);
        }
        while (p > L);
        return k - 1;
    }

    private static int PoissonLarge(float lambda)
    {
        // "Rejection method PA" from "The Computer Generation of 
        // Poisson Random Variables" by A. C. Atkinson,
        // Journal of the Royal Statistical Society Series C 
        // (Applied Statistics) Vol. 28, No. 1. (1979)
        // The article is on pages 29-35. 
        // The algorithm given here is on page 32.

        float c = 0.767F - 3.36F / lambda;
        float beta = Mathf.PI / Mathf.Sqrt(3.0F * lambda);
        float alpha = beta * lambda;
        float k = Mathf.Log(c) - lambda - Mathf.Log(beta);

        for (; ; )
        {
            float u = Random.Range(0F, 1F);
            float x = (alpha - Mathf.Log((1.0F - u) / u)) / beta;
            int n = (int)Mathf.Floor(x + 0.5F);
            if (n < 0)
                continue;
            float v = Random.Range(0F,1F);
            float y = alpha - beta * x;
            float temp = 1.0F + Mathf.Exp(y);
            float lhs = y + Mathf.Log(v / (temp * temp));
            float rhs = k + n * Mathf.Log(lambda) - LogFactorial(n);
            if (lhs <= rhs)
                return n;
        }
    }

    static float LogFactorial(int n)
    {
        if (n < 0)
        {
            return 0;
        }
        else if (n > 254)
        {
            float x = n + 1;
            return (x - 0.5F) * Mathf.Log(x) - x + 0.5F * Mathf.Log(2 * Mathf.PI) + 1.0F / (12.0F * x);
        }
        else
        {
            float[] lf =
            {
            0.000000000000000F,
            0.000000000000000F,
            0.693147180559945F,
            1.791759469228055F,
            3.178053830347946F,
            4.787491742782046F,
            6.579251212010101F,
            8.525161361065415F,
            10.604602902745251F,
            12.801827480081469F,
            15.104412573075516F,
            17.502307845873887F,
            19.987214495661885F,
            22.552163853123421F,
            25.191221182738683F,
            27.899271383840894F,
            30.671860106080675F,
            33.505073450136891F,
            36.395445208033053F,
            39.339884187199495F,
            42.335616460753485F,
            45.380138898476908F,
            48.471181351835227F,
            51.606675567764377F,
            54.784729398112319F,
            58.003605222980518F,
            61.261701761002001F,
            64.557538627006323F,
            67.889743137181526F,
            71.257038967168000F,
            74.658236348830158F,
            78.092223553315307F,
            81.557959456115029F,
            85.054467017581516F,
            88.580827542197682F,
            92.136175603687079F,
            95.719694542143202F,
            99.330612454787428F,
            102.968198614513810F,
            106.631760260643450F,
            110.320639714757390F,
            114.034211781461690F,
            117.771881399745060F,
            121.533081515438640F,
            125.317271149356880F,
            129.123933639127240F,
            132.952575035616290F,
            136.802722637326350F,
            140.673923648234250F,
            144.565743946344900F,
            148.477766951773020F,
            152.409592584497350F,
            156.360836303078800F,
            160.331128216630930F,
            164.320112263195170F,
            168.327445448427650F,
            172.352797139162820F,
            176.395848406997370F,
            180.456291417543780F,
            184.533828861449510F,
            188.628173423671600F,
            192.739047287844900F,
            196.866181672889980F,
            201.009316399281570F,
            205.168199482641200F,
            209.342586752536820F,
            213.532241494563270F,
            217.736934113954250F,
            221.956441819130360F,
            226.190548323727570F,
            230.439043565776930F,
            234.701723442818260F,
            238.978389561834350F,
            243.268849002982730F,
            247.572914096186910F,
            251.890402209723190F,
            256.221135550009480F,
            260.564940971863220F,
            264.921649798552780F,
            269.291097651019810F,
            273.673124285693690F,
            278.067573440366120F,
            282.474292687630400F,
            286.893133295426990F,
            291.323950094270290F,
            295.766601350760600F,
            300.220948647014100F,
            304.686856765668720F,
            309.164193580146900F,
            313.652829949878990F,
            318.152639620209300F,
            322.663499126726210F,
            327.185287703775200F,
            331.717887196928470F,
            336.261181979198450F,
            340.815058870798960F,
            345.379407062266860F,
            349.954118040770250F,
            354.539085519440790F,
            359.134205369575340F,
            363.739375555563470F,
            368.354496072404690F,
            372.979468885689020F,
            377.614197873918670F,
            382.258588773060010F,
            386.912549123217560F,
            391.575988217329610F,
            396.248817051791490F,
            400.930948278915760F,
            405.622296161144900F,
            410.322776526937280F,
            415.032306728249580F,
            419.750805599544780F,
            424.478193418257090F,
            429.214391866651570F,
            433.959323995014870F,
            438.712914186121170F,
            443.475088120918940F,
            448.245772745384610F,
            453.024896238496130F,
            457.812387981278110F,
            462.608178526874890F,
            467.412199571608080F,
            472.224383926980520F,
            477.044665492585580F,
            481.872979229887900F,
            486.709261136839360F,
            491.553448223298010F,
            496.405478487217580F,
            501.265290891579240F,
            506.132825342034830F,
            511.008022665236070F,
            515.890824587822520F,
            520.781173716044240F,
            525.679013515995050F,
            530.584288294433580F,
            535.496943180169520F,
            540.416924105997740F,
            545.344177791154950F,
            550.278651724285620F,
            555.220294146894960F,
            560.169054037273100F,
            565.124881094874350F,
            570.087725725134190F,
            575.057539024710200F,
            580.034272767130800F,
            585.017879388839220F,
            590.008311975617860F,
            595.005524249382010F,
            600.009470555327430F,
            605.020105849423770F,
            610.037385686238740F,
            615.061266207084940F,
            620.091704128477430F,
            625.128656730891070F,
            630.172081847810200F,
            635.221937855059760F,
            640.278183660408100F,
            645.340778693435030F,
            650.409682895655240F,
            655.484856710889060F,
            660.566261075873510F,
            665.653857411105950F,
            670.747607611912710F,
            675.847474039736880F,
            680.953419513637530F,
            686.065407301994010F,
            691.183401114410800F,
            696.307365093814040F,
            701.437263808737160F,
            706.573062245787470F,
            711.714725802289990F,
            716.862220279103440F,
            722.015511873601330F,
            727.174567172815840F,
            732.339353146739310F,
            737.509837141777440F,
            742.685986874351220F,
            747.867770424643370F,
            753.055156230484160F,
            758.248113081374300F,
            763.446610112640200F,
            768.650616799717000F,
            773.860102952558460F,
            779.075038710167410F,
            784.295394535245690F,
            789.521141208958970F,
            794.752249825813460F,
            799.988691788643450F,
            805.230438803703120F,
            810.477462875863580F,
            815.729736303910160F,
            820.987231675937890F,
            826.249921864842800F,
            831.517780023906310F,
            836.790779582469900F,
            842.068894241700490F,
            847.352097970438420F,
            852.640365001133090F,
            857.933669825857460F,
            863.231987192405430F,
            868.535292100464630F,
            873.843559797865740F,
            879.156765776907600F,
            884.474885770751830F,
            889.797895749890240F,
            895.125771918679900F,
            900.458490711945270F,
            905.796028791646340F,
            911.138363043611210F,
            916.485470574328820F,
            921.837328707804890F,
            927.193914982476710F,
            932.555207148186240F,
            937.921183163208070F,
            943.291821191335660F,
            948.667099599019820F,
            954.046996952560450F,
            959.431492015349480F,
            964.820563745165940F,
            970.214191291518320F,
            975.612353993036210F,
            981.015031374908400F,
            986.422203146368590F,
            991.833849198223450F,
            997.249949600427840F,
            1002.670484599700300F,
            1008.095434617181700F,
            1013.524780246136200F,
            1018.958502249690200F,
            1024.396581558613400F,
            1029.838999269135500F,
            1035.285736640801600F,
            1040.736775094367400F,
            1046.192096209724900F,
            1051.651681723869200F,
            1057.115513528895000F,
            1062.583573670030100F,
            1068.055844343701400F,
            1073.532307895632800F,
            1079.012946818975000F,
            1084.497743752465600F,
            1089.986681478622400F,
            1095.479742921962700F,
            1100.976911147256000F,
            1106.478169357800900F,
            1111.983500893733000F,
            1117.492889230361000F,
            1123.006317976526100F,
            1128.523770872990800F,
            1134.045231790853000F,
            1139.570684729984800F,
            1145.100113817496100F,
            1150.633503306223700F,
            1156.170837573242400F,
        };
            return lf[n];
        }
    }

}
